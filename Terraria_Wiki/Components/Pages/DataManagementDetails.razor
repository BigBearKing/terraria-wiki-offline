@page "/data/{WikiId:int}"
@using Terraria_Wiki.Components.Icons
@using Terraria_Wiki.Models
@using Terraria_Wiki.Services
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@implements IDisposable
<div class="page-anim page-content">
	<div class="header-with-back">
		<div class="icon-btn button" @onclick="BackToList">
			<Icon Name="arrow-left" Size="24" />
		</div>
		<span class="page-title">@_selectedWiki?.Title</span>
	</div>
	<div class="list-container">
		@* === 视图 2：详细管理页 === *@
		<div class="detail-container">
			@if (_selectedWiki != null)
			{

				@* --- 状态 A：已下载 (显示数据大小、更新按钮、页面列表) --- *@
				<div class="title-placeholder">
					<div class="placeholder-icon">📦</div>
					<h3>@(_selectedWiki.IsPageDownloaded? _selectedWiki.Title: "尚未获取数据")</h3>
					<p>@(_selectedWiki.IsPageDownloaded? _selectedWiki.Description: "你需要下载基础数据包和资源文件才能离线浏览此 Wiki。")</p>
				</div>
				@if (_selectedWiki.IsPageDownloaded)
				{
					@* 1. 数据概览卡片 *@
					<div class="stats-panel">
						<div class="stat-item">
							<span class="stat-label">数据库大小</span>
							<span class="stat-value">@AppService.GetSizeString(_selectedWiki.DataSize)</span>
						</div>

						<div class="stat-item">
							<span class="stat-label">页面数量</span>
							<span class="stat-value">@_selectedWiki.PageCount</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">重定向数量</span>
							<span class="stat-value">@_selectedWiki.RedirectCount</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">资源数量</span>
							<span class="stat-value">@_selectedWiki.ResourceCount</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">上次更新时间</span>
							<span class="stat-value">@_selectedWiki.DownloadedTime.ToString("yyyy-MM-dd\nHH:mm")</span>
						</div>
					</div>

					@* 2. 操作按钮 *@
					<div class="action-row">
						<div class="primary-btn btn-blue" @onclick="() => RunSafe(Update)">
							<Icon Name="sync" Size="16" />
							检查数据更新
						</div>

						<div class="primary-btn btn-green" @onclick="() => RunSafe(CleanUpRes)">
							<Icon Name="clean" Size="16" />
							清理未用资源
						</div>

						<div class="primary-btn btn-red" @onclick="() => RunSafe(DeleteRes)">
							<Icon Name="delete" Size="16" />
							删除图片数据
						</div>

						<div class="primary-btn btn-red" @onclick="() => RunSafe(Delete)">
							<Icon Name="delete" Size="16" />
							删除数据库
						</div>
					</div>

				}
				else
				{
					<div class="download-actions">

						<div class="download-card">
							<div class="dl-info">
								<div class="dl-title">所有内容</div>
								<div class="dl-desc">包含所有文本内容、属性和链接关系、图片、音视频。</div>
							</div>
							<div class="primary-btn btn-blue" @onclick="() => RunSafe(DownloadAll)">
								下载
							</div>
						</div>
						<div class="download-card">
							<div class="dl-info">
								<div class="dl-title">基础数据</div>
								<div class="dl-desc">仅包含所有文本内容、属性和链接关系。</div>
							</div>
							<div class="primary-btn btn-blue" @onclick="() => RunSafe(DownloadPages)">
								下载
							</div>
						</div>
					</div>
				}
				<div id="log-container" class="log-container">
					<Virtualize @ref="_virtualize"
								ItemsProvider="LoadLogs"
								Context="log"
								OverscanCount="20">
						<div class="log-line">@log</div>
					</Virtualize>
				</div>
			}

		</div>

	</div>
</div>
@code {
	[Parameter]
	public int WikiId { get; set; }
	private void BackToList()
	{
		AppState.CurrentPage = "data";
		NavManager.NavigateTo(AppState.CurrentPage);
	}
	private WikiBook _selectedWiki;
	protected override async Task OnInitializedAsync()
	{
		base.OnInitializedAsync();
		_selectedWiki = await App.ManagerDb.GetItemAsync<WikiBook>(WikiId);
		App.DataManager.CheckFailList();


	}
	protected override void OnInitialized()
	{
		base.OnInitialized();
		App.LogManager.OnLogAdded += RefreshUI;

	}

	//logs

	private Virtualize<string> _virtualize;


	private async ValueTask<ItemsProviderResult<string>> LoadLogs(ItemsProviderRequest req)
	{
		var total = App.LogManager.GetTotalCount();
		// 这里读取的永远是当前 _activeLogPath 的内容
		var items = await App.LogManager.GetLogsAsync(req.StartIndex, req.Count);
		return new ItemsProviderResult<string>(items, total);
	}

	private bool _isAutoScrolling = false; // 防止重入

	private async void RefreshUI()
	{
		// 如果正在处理中，跳过
		if (_isAutoScrolling) return;
		_isAutoScrolling = true;

		await InvokeAsync(async () =>
		{
			// 1. 告诉 Virtualize 数据变了
			if (_virtualize != null)
			{
				await _virtualize.RefreshDataAsync();
			}
			StateHasChanged();
			await JSRuntime.InvokeVoidAsync("scrollToBottom", "log-container");
		});

		_isAutoScrolling = false;
	}

	public void Dispose()
	{
		App.LogManager.OnLogAdded -= RefreshUI;
	}

	private async Task RunSafe(Func<Task> action)
	{
		// 统一检查
		if (AppState.IsDownloading)
		{
			await Application.Current.MainPage.DisplayAlert("提示", "请稍后，正在处理下载任务。", "确定");
			return;
		}
		await action();
	}
	private async Task DownloadAll()
	{
		_ = Task.Run(async () =>
		{
			await App.DataManager.DownloadDataAsync(true);
		});
	}
	private async Task DownloadPages()
	{
		_ = Task.Run(async () =>
		{
			await App.DataManager.DownloadDataAsync(false);
		});
	}
	private async Task Update()
	{

	}
	private async Task CleanUpRes()
	{

	}
	private async Task DeleteRes()
	{

	}
	private async Task Delete()
	{

	}

}
<style>
	.icon-btn {
		padding: 4px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.header-with-back {
		display: flex;
		align-items: center;
		gap: 8px;
		font-size: large;
		font-weight: 500;
	}

	/* === 详情页样式 === */
	.detail-container {
		display: flex;
		flex-direction: column;
		height: 100%;
		padding: 0 12px;
	}

	/* 统计面板 */
	.stats-panel {
		background-color: var(--bg-color-secondary);
		border-radius: 16px;
		padding: 20px;
		display: flex;
		margin-top: 12px;
		margin-bottom: 12px;
		align-items: stretch;
	}

	.stat-item {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
	}

	.stat-label {
		font-size: 0.8rem;
		color: var(--text-secondary);
		margin-bottom: 4px;
		text-align: center;
	}

	.stat-value {
		font-size: 1.1rem;
		font-weight: 600;
		color: var(--text-primary);
		white-space: pre-line;
		text-align: center;
	}

	/* 操作按钮 */
	.action-row {
		padding: 16px 0;
		display: flex;
		gap: 12px;
	}

	/* 通用按钮 */
	/* 1. 基础按钮样式重置 */
	.primary-btn {
		/* 移除之前的 background-color 和 color */
		padding: 12px 20px;
		border-radius: 12px;
		font-size: 1rem;
		font-weight: 500;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
		gap: 8px;
		/* 关键：添加平滑过渡 */
		transition: all 0.2s;
		border: none;
		/* 防止移动端点击出现高亮背景块 */
		-webkit-tap-highlight-color: transparent;
		-webkit-user-select: none;
		user-select: none;
	}

		/* 2. 交互反馈 (通用) */
		.primary-btn:hover {
			/* 悬停时：整体提亮 20% */
			/* 在深色背景下，brightness > 1 会让半透明色块显得更“实”、更亮 */
			filter: brightness(1.2);
		}

		.primary-btn:active {
			/* 点击时：稍微变暗并缩小，产生“按压感” */
			filter: brightness(1.0); /* 恢复亮度或稍微暗一点 */
			transform: scale(0.97); /* 物理回弹效果 */
		}

	/* === 颜色变体 (Tinted Style) === */

	/* 蓝色 */
	.btn-blue {
		background-color: var(--blue-tertiary);
		color: var(--blue-primary);
	}

	/* 绿色 */
	.btn-green {
		background-color: var(--green-tertiary);
		color: var(--green-primary);
	}

	/* 红色 */
	.btn-red {
		background-color: var(--red-tertiary);
		color: var(--red-primary);
	}

	.title-placeholder {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 40px 20px;
		text-align: center;
	}

	.placeholder-icon {
		font-size: 4rem;
		margin-bottom: 16px;
	}

	.title-placeholder h3 {
		margin: 0 0 8px 0;
		color: var(--text-primary);
	}

	.title-placeholder p {
		margin: 0;
		color: var(--text-secondary);
		font-size: 0.9rem;
	}

	.download-actions {
		display: flex;
		flex-direction: column;
		gap: 16px;
		padding-bottom: 24px;
	}

	.download-card {
		background-color: var(--bg-color-secondary);
		border-radius: 16px;
		padding: 16px;
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.dl-title {
		font-weight: 600;
		color: var(--text-primary);
		margin-bottom: 4px;
	}

	.dl-desc {
		font-size: 0.8rem;
		color: var(--text-secondary);
		line-height: 1.4;
	}

	.log-container {
		min-height: 200px;
		max-height: 200px;
		background-color: var(--bg-color-secondary);
		border-radius: 16px;
		padding: 16px;
		overflow-y: auto;
		font-size: 0.8rem;
		overflow-anchor: none;
	}

	.log-line {
		color: var(--text-secondary);
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
</style>